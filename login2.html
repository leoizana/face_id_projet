<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connexion avec Recoonnaissance Faciale</title>
    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js/dist/face-api.min.js"></script>
</head>
<body>
    <h1>Connexion avec Reconnaissance Faciale</h1>
    
    <video id="videoInput" width="640" height="480" autoplay playsinline></video>
    
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Polyfill plus complet pour iOS
            if (!navigator.mediaDevices) {
                navigator.mediaDevices = {};
            }

            navigator.mediaDevices.getUserMedia = navigator.mediaDevices.getUserMedia ||
                navigator.webkitGetUserMedia ||
                navigator.mozGetUserMedia ||
                navigator.msGetUserMedia;

            if (!navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia = function(constraints) {
                    var getUserMedia = navigator.getUserMedia ||
                        navigator.webkitGetUserMedia ||
                        navigator.mozGetUserMedia ||
                        navigator.msGetUserMedia;

                    if (!getUserMedia) {
                        return Promise.reject(
                            new Error('Ce navigateur ne supporte pas la capture vidéo. Veuillez utiliser Safari sur iOS.')
                        );
                    }

                    return new Promise(function(resolve, reject) {
                        getUserMedia.call(navigator, constraints, resolve, reject);
                    });
                }
            }

            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: "user"
                    },
                    audio: false
                });
                const videoInput = document.getElementById('videoInput');
                videoInput.srcObject = stream;
                videoInput.play();
            } catch (err) {
                console.error("Erreur complète:", err);
                alert("Erreur d'accès à la caméra. Veuillez vérifier que:\n1. Vous utilisez Safari\n2. Vous avez autorisé l'accès à la caméra\n3. Vous êtes en HTTPS");
            }

            console.log('Chargement des modèles...');
            await faceapi.nets.ssdMobilenetv1.loadFromUri('/models');
            await faceapi.nets.faceLandmark68Net.loadFromUri('/models');
            await faceapi.nets.faceRecognitionNet.loadFromUri('/models');
            console.log('Modèles chargés avec succès');

            // Charger les images des utilisateurs enregistrés
            const knownDescriptors = [];

            // Exemple de l'utilisateur KevAdams (ajouter toutes les photos de l'utilisateur)
            const imageKevAdams1 = await faceapi.fetchImage('/users/KevAdams/saphoto/1.jpg');
            const detectionsKevAdams1 = await faceapi.detectSingleFace(imageKevAdams1).withFaceLandmarks().withFaceDescriptor();
            if (detectionsKevAdams1) {
                knownDescriptors.push(new faceapi.LabeledFaceDescriptors('KevAdams', [detectionsKevAdams1.descriptor]));
            }

            const faceMatcher = new faceapi.FaceMatcher(knownDescriptors, 0.6); // 0.6 = seuil de correspondance

            // Modification de la détection vidéo
            videoInput.addEventListener('play', async () => {
                console.log("Détection en cours...");
                const canvas = faceapi.createCanvasFromMedia(videoInput);
                document.body.append(canvas);
                const displaySize = { width: videoInput.width, height: videoInput.height };
                faceapi.matchDimensions(canvas, displaySize);

                let detectionCount = 0;
                const requiredDetections = 3; // Nombre de détections positives requises
                let lastDetectedLabel = null;

                setInterval(async () => {
                    const detections = await faceapi.detectAllFaces(videoInput).withFaceLandmarks().withFaceDescriptors();
                    const resizedDetections = faceapi.resizeResults(detections, displaySize);
                    canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
                    faceapi.draw.drawDetections(canvas, resizedDetections);
                    faceapi.draw.drawFaceLandmarks(canvas, resizedDetections);

                    if (detections.length > 0) {
                        const bestMatch = faceMatcher.findBestMatch(detections[0].descriptor);
                        console.log(bestMatch.toString());

                        if (bestMatch.label !== 'unknown') {
                            if (lastDetectedLabel === bestMatch.label) {
                                detectionCount++;
                                console.log(`Détection ${detectionCount}/${requiredDetections}`);
                                
                                if (detectionCount >= requiredDetections) {
                                    alert(`Bienvenue, ${bestMatch.label}! Vous êtes connecté.`);
                                    window.location.href = `/home.html`;
                                }
                            } else {
                                detectionCount = 1;
                                lastDetectedLabel = bestMatch.label;
                            }
                        }
                    }
                }, 100);
            });
        });
    </script>
</body>
</html>
